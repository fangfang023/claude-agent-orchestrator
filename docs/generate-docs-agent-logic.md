# generate-docs-agent 功能逻辑梳理文档

## 1. 概述

### 1.1 核心定位

`generate-docs-agent.md` 是一个**文档生成工作流编排器**（Orchestrator），它的核心职责是：

- **意图解析**：理解用户想要生成什么类型的文档
- **任务规划**：制定执行策略和计划
- **工作流编排**：调度底层 Skills 执行具体任务
- **依赖管理**：处理文档间的依赖关系
- **并行优化**：识别可并行执行的任务以提高效率
- **质量审核**：协调文档质量检查流程

### 1.2 与 Skills 的关系

```
┌─────────────────────────────────────────────────────────────────┐
│                    架构层次关系                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  用户 (User)                                            │   │
│  │  "生成技术方案、交底书和专利"                            │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                         │
│                       ▼                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Agent (generate-docs-agent) - 编排层                    │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │ 意图解析     │ │ 任务规划     │ │ 工作流编排   │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                         │
│                       ▼                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Skills - 执行层 (实际生成文档)                          │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │tech-solution│ │tech-disclosure│ │patent-writing│ ... │   │
│  │  └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 关键区别

| 特性 | Agent (generate-docs-agent) | Skills |
|------|----------------------------|--------|
| **角色** | 编排器、调度者 | 执行者 |
| **职责** | 规划、协调、管理 | 具体文档生成 |
| **输入** | 用户意图 | 具体任务指令 |
| **输出** | 任务计划、进度报告 | 具体文档 |
| **工具使用** | Skill, Task, TodoWrite | Read, Write, Edit |
| **决策能力** | 智能判断执行策略 | 按固定流程执行 |

---

## 2. 实现架构图

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        generate-docs-agent 架构                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        输入层                                    │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │   │
│  │  │ 用户意图      │  │ 上下文信息    │  │ 文档类型映射表        │ │   │
│  │  │ (自然语言)    │  │ (项目信息)    │  │ (内置的 Skill 映射)   │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────────┘ │   │
│  └────────────────────────────┬────────────────────────────────────┘   │
│                               │                                         │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                       意图解析层                                  │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │   │
│  │  │ 创意提取      │  │ 文档类型识别  │  │ 执行模式检测          │ │   │
│  │  │ (提取N个创意) │  │ (专利/技术/论文)│  │ (串行/并行/迭代)      │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────────┘ │   │
│  └────────────────────────────┬────────────────────────────────────┘   │
│                               │                                         │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                       任务规划层                                  │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │   │
│  │  │ 依赖关系分析  │  │ 执行策略决策  │  │ 任务列表生成          │ │   │
│  │  │ (构建DAG)    │  │ (Skill/Task) │  │ (TodoWrite)          │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────────┘ │   │
│  └────────────────────────────┬────────────────────────────────────┘   │
│                               │                                         │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      执行编排层                                   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │              并行任务分发器                               │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │   │   │
│  │  │  │ Task 1  │ │ Task 2  │ │ Task 3  │ │ Task N  │ ...   │   │   │
│  │  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘       │   │   │
│  │  └───────┼──────────┼──────────┼──────────┼────────────────┘   │   │
│  │          │          │          │          │                      │   │
│  │          ▼          ▼          ▼          ▼                      │   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │                    Skills 执行层                         │   │   │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐          │   │   │
│  │  │  │ Skill1 │ │ Skill2 │ │ Skill3 │ │ SkillN │  ...      │   │   │
│  │  │  └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘          │   │   │
│  │  └──────┼──────────┼──────────┼──────────┼────────────────┘   │   │
│  └─────────┼──────────┼──────────┼──────────┼─────────────────────┘   │
│            │          │          │          │                          │
│            ▼          ▼          ▼          ▼                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      输出层                                      │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │   │
│  │  │ 生成的文档    │  │ 质量审核报告  │  │ 任务执行摘要          │ │   │
│  │  │ (Markdown)   │  │ (评分/意见)   │  │ (状态/路径统计)        │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### 2.2 组件交互图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          组件交互流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   用户                                                                 │
│    │                                                                    │
│    │ "生成技术方案、交底书和专利"                                        │
│    ▼                                                                    │
│ ┌─────────────────────────────────────────┐                            │
│ │  generate-docs-agent (编排器)             │                            │
│ │  ┌─────────────────────────────────┐    │                            │
│ │  │ 1. 意图解析                       │    │                            │
│ │  │    - 创意: 1个                    │    │                            │
│ │  │    - 文档: 技术方案、交底书、专利  │    │                            │
│ │  │    - 模式: 串行(有依赖)            │    │                            │
│ │  └─────────────────────────────────┘    │                            │
│ │  ┌─────────────────────────────────┐    │                            │
│ │  │ 2. 任务规划                       │    │                            │
│ │  │    任务1: tech-solution (依赖:无) │    │                            │
│ │  │    任务2: tech-disclosure (依赖:1)│    │                            │
│ │  │    任务3: patent-writing (依赖:2) │    │                            │
│ │  └─────────────────────────────────┘    │                            │
│ │  ┌─────────────────────────────────┐    │                            │
│ │  │ 3. TodoWrite(todos=[...])        │    │                            │
│ │  └─────────────────────────────────┘    │                            │
│ └──────┬───────────────────────────────────┘                            │
│         │                                                                 │
│         ├──► Skill tool ──► tech-solution skill ──► 技术方案.md             │
│         │                                                                 │
│         ├──► Skill tool ──► tech-disclosure skill ──► 交底书.md             │
│         │                                                                 │
│         └──► Skill tool ──► patent-writing skill ──► 专利.md               │
│                                                                           │
│   用户                                                                 │
│    │                                                                    │
│    └─ 收到生成的文档和执行报告                                           │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 实现逻辑流程图

### 3.1 主执行流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        generate-docs-agent 主流程                          │
└─────────────────────────────────────────────────────────────────────────┘

   开始
    │
    ▼
┌─────────────────────┐
│  接收用户输入         │
│  (自然语言意图)       │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐     ┌─────────────────────┐
│  步骤1: 意图解析      │────►│ 输出意图解析结果      │
│  - 提取创意            │     │ - 创意数量           │
│  - 识别文档类型        │     │ - 文档类型列表       │
│  - 检测执行模式        │     │ - 执行模式           │
└─────────┬───────────┘     └─────────────────────┘
          │
          ▼
┌─────────────────────┐     ┌─────────────────────┐
│  步骤2: 规划与展示    │────►│ 输出执行计划          │
│  - 分析依赖关系        │     │ - 任务列表           │
│  - 决定执行策略        │     │ - 输出目录           │
│  - 创建任务列表        │     │                     │
│  (TodoWrite)          │     │                     │
└─────────┬───────────┘     └─────────────────────┘
          │
          ▼
    ┌─────────────┐
    │ 判断执行模式 │
    └──┬──────┬───┘
       │      │
       │      ├──► 串行模式
       │      │       │
       │      │       ▼
       │      │  ┌─────────────────────┐
       │      │  │  步骤3: 串行执行      │
       │      │  │  - 按依赖顺序执行     │
       │      │  │  - 使用 Skill tool   │
       │      │  │  - 逐个更新 TodoWrite │
       │      │  └─────────────────────┘
       │      │
       │      └──► 并行模式
       │              │
       │              ▼
       │         ┌─────────────────────┐
       │         │  步骤3: 并行执行      │
       │         │  - 同时发起多个 Task │
       │         │  - TaskOutput 等待   │
       │         │  - 批量更新 TodoWrite │
       │         └─────────────────────┘
       │
       ▼
┌─────────────────────┐
│  步骤4: 质量审核      │
│  - 调用 document-   │
│    reviewer skill   │
│  - 评分 >= 80 通过   │
│  - 否则重新生成       │
│  (最多3次)          │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐     ┌─────────────────────┐
│  步骤5: 结果汇总      │────►│ 输出执行报告          │
│  - 收集所有生成结果    │     │ - 文档状态表         │
│  - 统计成功/失败       │     │ - 路径信息           │
└─────────┬───────────┘     └─────────────────────┘
          │
          ▼
         结束
```

### 3.2 意图解析流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          意图解析子流程                                  │
└─────────────────────────────────────────────────────────────────────────┘

   用户输入
    │
    │ "生成技术方案、交底书和专利"
    ▼
┌─────────────────────┐
│  创意提取            │
│  - 识别核心创意点     │
│  - 提取创意描述       │
│  - 分配创意ID         │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  文档类型识别        │
│  - 关键词匹配         │
│  - 类型推断           │
│  (专利/技术/论文)     │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  执行模式检测        │
│  - 关键词分析         │
│  - 依赖关系判断       │
│  - 模式分类:          │
│    • 简单顺序          │
│    • 链式依赖          │
│    • 并行分支          │
│    • 迭代处理          │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  输出意图解析结果     │
│  ## 📋 意图解析       │
│  - 检测到创意: 1个    │
│  - 文档类型: 技术方案, │
│              交底书, │
│              专利     │
│  - 执行模式: 串行      │
└─────────────────────┘
```

### 3.3 任务规划流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          任务规划子流程                                  │
└─────────────────────────────────────────────────────────────────────────┘

   意图解析结果
    │
    ▼
┌─────────────────────┐
│  依赖关系分析        │
│  - 查询内置映射表     │
│  - 构建依赖DAG        │
│                     │
│  映射表:             │
│  tech-solution → 无   │
│  tech-disclosure →    │
│    tech-solution      │
│  patent-writing →     │
│    tech-disclosure    │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  执行策略决策        │
│  ┌──────────────┐   │
│  │ 单任务?       │──►│ Skill tool
│  └──────────────┘   │
│  ┌──────────────┐   │
│  │ 有依赖?       │──►│ Skill tool (串行)
│  └──────────────┘   │
│  ┌──────────────┐   │
│  │ 无依赖?       │──►│ Task tool (并行)
│  └──────────────┘   │
│  ┌──────────────┐   │
│  │ 批量创意?     │──►│ Task tool (强制并行)
│  └──────────────┘   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  任务列表生成        │
│  TodoWrite([        │
│    {              │
│      content: "...",│
│      status: "pending",│
│      activeForm: "..."│
│    }, ...           │
│  ])                 │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  输出执行计划        │
│  ## 📋 执行计划      │
│  - 创意1: ... → [...]│
│  - 输出目录: ...     │
└─────────────────────┘
```

### 3.4 并行执行流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          并行执行子流程                                  │
└─────────────────────────────────────────────────────────────────────────┘

   并行任务列表
    │
    │ [Task1, Task2, Task3]
    ▼
┌─────────────────────┐
│  更新任务状态        │
│  TodoWrite(todos = [ │
│    {status: in_progress},│
│    {status: in_progress},│
│    {status: in_progress} │
│  ])                 │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│  关键: 在单个响应中同时发起多个 Task                        │
│                                                              │
│  ✅ 正确（并行）:                                            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                       │
│  │ Task 1  │ │ Task 2  │ │ Task 3  │ (同时发起)              │
│  └─────────┘ └─────────┘ └─────────┘                       │
│                                                              │
│  ❌ 错误（串行）:                                            │
│  ┌─────────┐                                               │
│  │ Task 1  │ → 等待完成 → ┌─────────┐                      │
│  └─────────┘               │ Task 2  │ ...                  │
│                            └─────────┘                       │
└─────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────┐
│  等待所有任务完成     │
│  TaskOutput(         │
│    task_id: id1,     │
│    block: true,      │
│    ...               │
│  )                   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  更新所有任务状态     │
│  TodoWrite(todos = [ │
│    {status: completed},│
│    {status: completed},│
│    {status: completed} │
│  ])                 │
└─────────────────────┘
```

### 3.5 质量审核流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          质量审核子流程                                  │
└─────────────────────────────────────────────────────────────────────────┘

   生成的文档
    │
    ▼
┌─────────────────────┐
│  检查是否有审核标准   │
│  - 查询 knowledge 库  │
│  - document-reviewer │
└─────┬───────────┬───┘
      │           │
      │ 否         │ 是
      ▼           ▼
┌──────────┐  ┌─────────────────────┐
│ 跳过审核  │  │ 调用 document-      │
│ 输出警告  │  │ reviewer skill      │
└──────────┘  └─────────┬───────────┘
                         │
                         ▼
                    ┌─────────┐
                    │ 评分>=80?│
                    └──┬────┬──┘
                       │    │
                       │是  │否
                       │    ▼
                       │ ┌────────────┐
                       │ │ attempt<3? │
                       │ └──┬─────┬───┘
                       │    │     │
                       │    │是   │否
                       │    ▼     ▼
                       │ ┌─────┐ ┌──────┐
                       │ │重新 │ │标记  │
                       │ │生成 │ │失败  │
                       │ └──┬──┘ └──────┘
                       │    │
                       │    └──► 循环
                       │
                       ▼
              ┌─────────────────────┐
              │ 输出审核报告          │
              │ - 综合评分            │
              │ - 分项评分            │
              │ - 改进建议            │
              └─────────────────────┘
```

---

## 4. 关键逻辑说明

### 4.1 文档类型映射表

Agent 内置了完整的文档类型到 Skill 的映射关系：

```python
# 论文类（可并行）
paper_types = {
    "工程论文": {
        "skill": "paper/engineering-paper",
        "dependency": "tech-solution",
        "parallel": True
    },
    "经济论文": {
        "skill": "paper/economy-paper",
        "dependency": "tech-solution",
        "parallel": True
    },
    "科学论文": {
        "skill": "paper/science-paper",
        "dependency": "tech-solution",
        "parallel": True
    }
}

# 专利类（有依赖链）
patent_types = {
    "技术交底书": {
        "skill": "patent/tech-disclosure",
        "dependency": "tech-solution",
        "order": 1
    },
    "专利创新评估": {
        "skill": "patent/patent-innovation-assessment-report",
        "dependency": "tech-disclosure",
        "order": 2
    },
    "商业价值分析": {
        "skill": "patent/business-analysis",
        "dependency": "tech-disclosure",
        "order": 2
    },
    "权利要求书": {
        "skill": "patent/patent-writing",
        "dependency": "tech-disclosure",
        "order": 3
    },
    "IP保护策略": {
        "skill": "patent/ip-strategy",
        "dependency": "tech-disclosure",
        "order": 4
    }
}

# 技术文档类
technical_types = {
    "技术方案": {"skill": "technical/tech-solution", "dependency": None},
    "价值主张": {"skill": "technical/value-proposition", "dependency": None},
    "立论白皮书": {"skill": "technical/thesis-doc", "dependency": None},
    "项目可行性": {"skill": "technical/project-feasibility-assessment-report", "dependency": None},
    "伦理风险": {"skill": "technical/ethics-report", "dependency": None},
    "合规标准": {"skill": "technical/standard-doc", "dependency": None}
}
```

### 4.2 执行方式决策逻辑

```python
def decide_execution_mode(task_info):
    """根据任务特征决定执行方式"""

    # 1. 单任务判断
    if len(task_info.documents) == 1:
        return "serial", "Skill tool"

    # 2. 依赖关系检查
    has_dependency = any(doc.get("dependency") for doc in task_info.documents)
    if has_dependency:
        return "serial", "Skill tool"

    # 3. 无依赖任务判断
    independent_tasks = [doc for doc in task_info.documents if not doc.get("dependency")]
    if len(independent_tasks) > 1:
        return "parallel", "Task tool"

    # 4. 批量创意判断
    if len(task_info.ideas) > 1:
        return "parallel_force", "Task tool"

    return "serial", "Skill tool"
```

### 4.3 工作流模式识别

```python
# 模式特征关键词
workflow_patterns = {
    "simple_sequential": {
        "keywords": ["生成", "创建", "写"],
        "execution": "serial_or_parallel"
    },
    "chain_dependency": {
        "keywords": ["先", "然后", "接着", "最后", "之后"],
        "execution": "serial"
    },
    "parallel_branch": {
        "keywords": ["同时", "分别", "各自", "并行"],
        "execution": "parallel"
    },
    "iterative": {
        "keywords": ["对每个", "所有", "每篇", "从每篇"],
        "execution": "iterative"
    }
}

def detect_workflow_pattern(user_input):
    """检测用户输入中的工作流模式"""
    detected_patterns = []

    for pattern, config in workflow_patterns.items():
        for keyword in config["keywords"]:
            if keyword in user_input:
                detected_patterns.append({
                    "pattern": pattern,
                    "keyword": keyword,
                    "execution": config["execution"]
                })
                break

    return detected_patterns
```

### 4.4 迭代任务处理

```python
def handle_iterative_tasks(source_documents, target_doc_type):
    """处理迭代任务：为每个源文档生成对应的目标文档"""

    # 1. 收集迭代源
    source_docs = read_generated_documents(source_documents)

    # 2. 为每个源创建子任务
    subtasks = []
    for idx, doc in enumerate(source_docs):
        subtask = {
            "source": doc,
            "target_type": target_doc_type,
            "output_dir": f"./generated_docs/[timestamp]/idea-{idx+1}/"
        }
        subtasks.append(subtask)

    # 3. 并行执行所有子任务
    results = execute_parallel_tasks(subtasks)

    return results
```

---

## 5. 提示词关键说明

### 5.1 核心提示词结构

```yaml
---
name: generate-docs-agent
description: 智能文档生成专家，支持多类型文档生成、依赖关系管理、批量处理和工作流编排
tools: Skill, Task, Read, Write, Edit, Glob, Grep, Bash, TodoWrite
---

# 智能文档生成专家

你是文档生成工作流编排器。解析用户意图，调用底层 skills 生成文档。
```

**设计意图**：
- `description`: 精确定义了 Agent 的四大核心能力
- `tools`: 列出了 Agent 可用的工具，其中：
  - `Skill`: 用于调用单个文档生成 skill
  - `Task`: 用于创建并行执行的子代理
  - `TodoWrite`: 用于任务进度管理

### 5.2 角色定位提示

```markdown
# 智能文档生成专家

你是文档生成工作流编排器。解析用户意图，调用底层 skills 生成文档。
```

**关键点**：
- 明确定位为"编排器"而非"执行者"
- 强调"调用底层 skills"，清晰分层
- 避免直接生成文档，而是协调生成流程

### 5.3 快速参考表设计

```markdown
## 快速参考

### 完整文档类型映射

#### 论文类（可并行）
| 类型 | Skill | 依赖 | 并行 |
|-----|-------|-----|------|
| 工程论文 | paper/engineering-paper | tech-solution | ✅ |
```

**设计意图**：
- 为 Agent 提供内置的决策依据
- 明确依赖关系和并行可能性
- 便于快速查找和匹配

### 5.4 执行方式决策表

```markdown
### 执行方式决策

| 场景 | 方式 | 工具 |
|-----|------|-----|
| 单任务 | 串行 | Skill |
| 有依赖 | 串行 | Skill |
| 无依赖 | **并行** | Task |
| 批量创意 | **强制并行** | Task |
```

**关键决策规则**：
1. **单任务** → Skill（直接调用，无需并行）
2. **有依赖** → Skill（必须串行，保证依赖顺序）
3. **无依赖** → Task（并行提高效率）
4. **批量创意** → Task（强制并行，处理多个创意）

### 5.5 并行执行关键提示

```markdown
#### 🔴 并行执行规则

**关键：在单个响应中同时发起多个 Task**

✅ 正确（并行）：
```
同时发起 3 个任务：
<tool_use>...Task...</tool_use>
<tool_use>...Task...</tool_use>
<tool_use>...Task...</tool_use>
```

❌ 错误（串行）：
```
<tool_use>...Task...</tool_use>
# 等待完成...
<tool_use>...Task...</tool_use>
```
```

**关键点**：
- 明确指出必须在**单个响应**中发起多个 Task
- 这是实现真正的并行执行的关键
- 如果等待前一个完成再发起下一个，就变成串行了

### 5.6 步骤输出规范

```markdown
### 第 1 步：意图解析（必须输出）

提取创意、文档类型、执行模式后，**必须向用户输出**：

```markdown
## 📋 意图解析

- 检测到创意：[N] 个
- 文档类型：专利/交底书/...
- 执行模式：[串行/并行]
```
```

**设计意图**：
- 强制 Agent 向用户展示理解结果
- 确保用户确认意图被正确解析
- 提供透明的执行过程

### 5.7 迭代处理提示

```markdown
### 迭代任务处理

当检测到迭代模式时（如"对每个...从每篇..."）：

1. **收集迭代源**：获取上一步骤的所有输出
2. **创建子任务**：为每个输出项创建相应的生成任务
3. **组织输出结构**：为每个迭代项创建独立的子目录
```

**关键能力**：
- Agent 能识别"对每个..."的迭代模式
- 自动为每个源创建独立的子任务
- 组织清晰的输出目录结构

---

## 6. 典型使用场景

### 6.1 场景一：简单并行任务

**用户输入**：
```
生成技术方案和商业价值报告
```

**Agent 执行流程**：
```
1. 意图解析
   - 创意: 1个
   - 文档: 技术方案、商业价值报告
   - 模式: 并行（无依赖）

2. 任务规划
   - 任务1: technical/tech-solution
   - 任务2: technical/value-proposition
   - 输出目录: ./generated_docs/[20250120_120000]/

3. 并行执行
   同时发起 2 个 Task:
   - Task 1 → tech-solution skill
   - Task 2 → value-proposition skill

4. 结果汇总
   技术方案.md ✅
   商业价值报告.md ✅
```

### 6.2 场景二：链式依赖任务

**用户输入**：
```
生成完整的专利申请文档链
```

**Agent 执行流程**：
```
1. 意图解析
   - 创意: 1个
   - 文档: 技术方案→交底书→专利
   - 模式: 串行（有依赖）

2. 任务规划（构建依赖链）
   tech-solution (无依赖)
       ↓
   tech-disclosure (依赖: tech-solution)
       ↓
   patent-writing (依赖: tech-disclosure)

3. 串行执行
   Skill tool → tech-solution
       ↓ (读取结果)
   Skill tool → tech-disclosure
       ↓ (读取结果)
   Skill tool → patent-writing

4. 结果汇总
   技术方案.md ✅
   交底书.md ✅
   专利.md ✅
```

### 6.3 场景三：复杂迭代工作流

**用户输入**：
```
根据创意生成技术方案，然后生成工程论文、科学论文、经济论文，
接着从每篇论文挖掘1个新创意，为每个新创意生成交底书和商业价值报告
```

**Agent 执行流程**：
```
1. 意图解析
   - 创意: 1个初始 → 3个衍生
   - 检测到迭代模式: "从每篇论文"
   - 执行模式: 分阶段执行

2. 任务规划
   阶段1: 技术方案 (tech-solution)
   阶段2: 三类论文 (并行)
   阶段3: 创意挖掘 (迭代)
   阶段4: 衍生文档 (迭代并行)

3. 执行过程
   [阶段1] tech-solution
       ↓
   [阶段2] 并行发起3个Task
       ├── engineering-paper
       ├── science-paper
       └── economy-paper
       ↓
   [阶段3] 读取3篇论文，各提取1个新创意
       ↓
   [阶段4] 为3个创意各创建2个文档
       ├── 创意1: tech-disclosure + business-analysis
       ├── 创意2: tech-disclosure + business-analysis
       └── 创意3: tech-disclosure + business-analysis

4. 输出结构
   ./generated_docs/[timestamp]/
   ├── tech-solution.md
   ├── papers/
   │   ├── engineering-paper.md
   │   ├── science-paper.md
   │   └── economy-paper.md
   └── derived/
       ├── idea-1/
       │   ├── tech-disclosure.md
       │   └── business-analysis.md
       ├── idea-2/
       └── idea-3/
```

---

## 7. 关键提示词逻辑详解

### 7.1 快速参考表的作用

```markdown
## 快速参考

### 完整文档类型映射
- 内置的文档类型到 Skill 的映射关系
- 明确标注了依赖关系和并行可能性
- 作为 Agent 决策的"知识库"

### 执行方式决策
- 根据场景自动选择执行方式
- 决定使用 Skill tool 还是 Task tool
- 平衡效率和正确性
```

### 7.2 并行执行规则的重要性

这是整个 Agent 最关键的提示词部分：

```markdown
#### 🔴 并行执行规则

**关键：在单个响应中同时发起多个 Task**
```

**为什么重要**：
- Claude 默认是串行执行的
- 要实现并行，必须在单个响应中发起多个 Task
- 这是系统级别的限制

**实现方式**：
```xml
<tool_use>...Task 1...</tool_use>
<tool_use>...Task 2...</tool_use>
<tool_use>...Task 3...</tool_use>
```

### 7.3 迭代处理的实现

```markdown
### 迭代任务处理

当检测到迭代模式时（如"对每个...从每篇..."）：

1. **收集迭代源**：获取上一步骤的所有输出
2. **创建子任务**：为每个输出项创建相应的生成任务
3. **组织输出结构**：为每个迭代项创建独立的子目录
```

**工作原理**：
1. 识别"对每个"、"从每篇"等迭代关键词
2. 读取上一步骤的所有输出文件
3. 为每个输出创建独立的子任务
4. 组织清晰的目录结构

---

## 8. 与 Skills 的调用关系

### 8.1 调用层次

```
┌─────────────────────────────────────────────────────────────┐
│                      调用层次                                 │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  用户                                                          │
│   │                                                            │
│   │ "生成技术方案"                                             │
│   ▼                                                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ generate-docs-agent (编排器)                           │   │
│  │                                                        │   │
│  │ 1. 解析意图 → 识别为 "tech-solution"                   │   │
│  │ 2. 规划任务 → 单任务, 无依赖                           │   │
│  │ 3. 执行决策 → 使用 Skill tool                          │   │
│  │ 4. 发起调用 → Skill("tech-solution")                   │   │
│  └───────────────────────────────────────────────────────┘   │
│                          │                                    │
│                          ▼                                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ tech-solution Skill (执行器)                          │   │
│  │                                                        │   │
│  │ 1. 接收任务                                            │   │
│  │ 2. 阶段1: 需求分析                                    │   │
│  │ 3. 阶段2: 结构设计                                    │   │
│  │ 4. 阶段3: 内容生成                                    │   │
│  │ 5. 阶段4: 质量审核                                    │   │
│  │ 6. 输出: 技术方案文档                                  │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 8.2 并行调用场景

```
┌─────────────────────────────────────────────────────────────┐
│                    并行调用场景                                │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  用户                                                          │
│   │                                                            │
│   │ "生成工程论文、科学论文、经济论文"                        │
│   ▼                                                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ generate-docs-agent (编排器)                           │   │
│  │                                                        │   │
│  │ 1. 解析意图 → 识别为3个论文类型                         │   │
│  │ 2. 检测依赖 → 都依赖 tech-solution                      │   │
│  │ 3. 检测并行 → 可并行执行                                 │   │
│  │ 4. 决策 → 使用 Task tool 并行                           │   │
│  │                                                        │   │
│  │ 5. 同时发起3个Task:                                     │   │
│  │     Task("paper/engineering-paper")                    │   │
│  │     Task("paper/science-paper")                        │   │
│  │     Task("paper/economy-paper")                        │   │
│  └───────────────────────────────────────────────────────┘   │
│          │             │             │                          │
│          ▼             ▼             ▼                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │Sub-agent1│  │Sub-agent2│  │Sub-agent3│ (并行执行)          │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘                   │
│        │             │             │                          │
│        ▼             ▼             ▼                          │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  各自调用对应的 Skill                                  │ │
│  │   • engineering-paper Skill                           │ │
│  │   • science-paper Skill                               │ │
│  │   • economy-paper Skill                               │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 8.3 依赖链调用场景

```
┌─────────────────────────────────────────────────────────────┐
│                    依赖链调用场景                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  用户                                                          │
│   │                                                            │
│   │ "生成技术方案→交底书→专利"                                │
│   ▼                                                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ generate-docs-agent (编排器)                           │   │
│  │                                                        │   │
│  │ 1. 解析意图 → 识别为链式依赖                            │   │
│  │ 2. 构建依赖链:                                         │   │
│  │    tech-solution (无依赖)                              │   │
│  │         ↓                                              │   │
│  │    tech-disclosure (依赖: tech-solution)               │   │
│  │         ↓                                              │   │
│  │    patent-writing (依赖: tech-disclosure)              │   │
│  │                                                        │   │
│  │ 3. 决策 → 使用 Skill tool 串行                          │   │
│  │ 4. 串行执行:                                           │   │
│  │    Skill("tech-solution")                              │   │
│  │         ↓ (读取结果)                                   │   │
│  │    Skill("tech-disclosure", 基于上一步)                  │   │
│  │         ↓ (读取结果)                                   │   │
│  │    Skill("patent-writing", 基于上一步)                  │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 9. 总结

### 9.1 Agent 核心价值

`generate-docs-agent.md` 作为文档生成工作流编排器，其核心价值在于：

1. **智能理解**：解析用户意图，识别文档类型和执行模式
2. **自动规划**：构建任务列表，分析依赖关系，决策执行策略
3. **高效执行**：通过并行处理优化性能
4. **流程透明**：向用户展示解析结果和执行计划
5. **质量保证**：集成审核流程，确保文档质量

### 9.2 与 Skills 的关系总结

| 维度 | Agent | Skills |
|------|-------|--------|
| **角色** | 编排器 | 执行者 |
| **职责** | 规划、协调 | 生成 |
| **输入** | 用户意图 | 具体任务 |
| **输出** | 计划、进度报告 | 文档 |
| **智能性** | 决策、判断 | 执行流程 |
| **工具** | Task, TodoWrite | Read, Write |

### 9.3 设计原则

1. **分层清晰**：Agent 负责编排，Skills 负责执行
2. **智能决策**：自动识别模式，选择最优执行策略
3. **透明可控**：每步都向用户展示进度和结果
4. **高效并行**：最大化利用并行执行能力
5. **质量保证**：内置审核循环机制

---

**文档版本**: 1.0
**创建日期**: 2026-01-20
**维护者**: Extensions System
