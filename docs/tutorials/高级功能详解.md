# 高级功能详解

本文档详细介绍了 Claude Code 中文开发套件的高级功能，包括原理说明、配置方法和最佳实践。

## 🧠 智能上下文管理

### 三层文档架构

**基础层 (Tier 1)**
- `CLAUDE.md` - 项目核心文档，包含架构、编码规范、安全标准
- `project-structure.md` - 完整项目结构和技术栈说明
- `docs-overview.md` - 文档系统概览

**组件层 (Tier 2)**
- `CONTEXT-tier2-component.md` - 组件级别上下文文档
- 模块化组件说明和接口定义

**功能层 (Tier 3)**
- `CONTEXT-tier3-feature.md` - 功能级别上下文文档
- 具体功能实现和使用说明

### 自动上下文注入

**工作原理：**
- 使用 Task 工具创建子智能体时，自动注入核心项目上下文
- `subagent-context-injector` hook 负责自动加载
- 确保所有子智能体立即访问基本项目文档

**配置方法：**
```bash
# 查看当前上下文配置
cat .claude/hooks/subagent-context-injector.sh
```

## 🔧 Hook 系统

### 可用 Hook 类型

**任务相关 Hook：**
- `pre-task-hook` - 任务执行前运行
- `post-task-hook` - 任务执行后运行
- `subagent-context-injector` - 子智能体上下文注入

**MCP 相关 Hook：**
- `gemini-context-injector` - Gemini 咨询上下文注入
- `mcp-security-check` - MCP 调用安全检查

**通知相关 Hook：**
- `notification-hook` - 系统通知处理

### 自定义 Hook 开发

**创建自定义 Hook：**
```bash
# 1. 在 .claude/hooks/ 目录创建脚本
vim .claude/hooks/my-custom-hook.sh

# 2. 添加执行权限
chmod +x .claude/hooks/my-custom-hook.sh

# 3. 在 settings.json 中配置
```

**Hook 脚本示例：**
```bash
#!/bin/bash
# my-custom-hook.sh

echo "🎯 自定义 Hook 执行中..."
# 你的自定义逻辑
```

## 🎵 自定义通知音效

### 支持的音效类型

**默认音效文件：**
- `complete.mp3` - 任务完成音效
- `input.mp3` - 输入提示音效
- `error.mp3` - 错误提示音效

### 替换音效方法

**方法一：直接替换文件**
```bash
# 替换任务完成音效
cp your-sound.mp3 .claude/hooks/sounds/complete.mp3

# 替换输入提示音效
cp your-sound.mp3 .claude/hooks/sounds/input.mp3
```

**方法二：自定义音效路径**
```bash
# 在 settings.json 中配置自定义音效路径
{
  "hooks": {
    "sounds": {
      "complete": "/path/to/your/complete.mp3",
      "input": "/path/to/your/input.mp3"
    }
  }
}
```

### 音效格式要求

- **格式支持：** `.mp3`, `.wav`, `.aiff`
- **文件大小：** 建议小于 1MB
- **播放时长：** 建议 1-3 秒
- **音量控制：** 适中音量，避免刺耳

## 🔒 安全扫描

### 安全检查内容

**敏感信息检测：**
- API 密钥和访问令牌
- 密码和认证凭据
- 个人身份信息 (PII)
- 私有代码片段
- 数据库连接字符串

**MCP 调用安全：**
- 所有 MCP 调用前自动检查
- 阻止包含敏感信息的请求
- 提供安全替代方案

### 配置安全规则

**自定义敏感词：**
```bash
# 在 .claude/hooks/mcp-security-check.sh 中添加
SENSITIVE_PATTERNS=(
    "api_key"
    "password"
    "secret"
    "token"
    "private_key"
)
```

**白名单配置：**
```bash
# 允许特定模式的安全传输
SAFE_PATTERNS=(
    "public_api"
    "demo_key"
    "test_token"
)
```

## 🤖 Skills 系统

### Skills 架构原理

**核心概念：**
- **自动调用** - Claude 根据用户需求智能选择合适的 skill
- **渐进加载** - 只在需要时加载，节省上下文空间
- **模块化设计** - 每个 skill 专注特定领域

**文件结构：**
```
.claude/skills/
├── skill-name/
│   ├── SKILL.md          # 技能定义和指令
│   ├── README.md         # 用户文档
│   └── resources/        # 资源文件（可选）
```

### 创建自定义 Skill

**步骤 1：创建技能目录**
```bash
mkdir -p .claude/skills/my-skill
```

**步骤 2：编写 SKILL.md**
```markdown
---
name: my-skill
description: 我的自定义技能描述
---

# 我的自定义技能

[技能详细指令和逻辑...]
```

**步骤 3：编写 README.md**
```markdown
# 我的自定义技能

使用说明和使用示例...
```

### 技能部署方式

**全局部署（推荐）：**
```bash
cp -r .claude/skills/my-skill ~/.claude/skills/
```

**项目级别部署：**
```bash
mkdir -p .claude/skills/
cp -r templates/.claude/skills/my-skill .claude/skills/
```

## 📡 MCP 服务器集成

### Gemini 咨询服务器

**工作原理：**
- 使用 `gemini-context-injector.sh` hook 自动注入项目上下文
- 支持持续对话会话管理
- 多文件分析和缓存机制

**咨询模式：**
- **解决模式** - 具体问题解决方案
- **审查模式** - 代码质量和架构审查
- **调试模式** - 问题诊断和修复
- **优化模式** - 性能优化建议
- **解释模式** - 复杂概念解释

### Context7 文档服务器

**支持的库类型：**
- 前端框架 (React, Vue, Angular)
- 后端框架 (FastAPI, Express, Django)
- 数据库和工具 (PostgreSQL, Redis)
- 云服务和部署 (AWS, Docker, Kubernetes)

**文档获取流程：**
1. 解析库名为 Context7 ID
2. 获取焦点文档内容
3. 提供实用代码示例
4. 解释最新特性和变化

## 🔧 性能优化

### 上下文管理优化

**减少上下文大小：**
- 使用 Skills 的渐进加载特性
- 合理分层文档架构
- 避免重复信息

**提高响应速度：**
- 优化 Hook 脚本执行效率
- 合理配置 MCP 服务器
- 使用缓存机制

### 内存管理

**监控内存使用：**
```bash
# 查看 Claude Code 内存使用
ps aux | grep claude | grep -v grep
```

**优化建议：**
- 定期清理临时文件
- 合理配置会话超时
- 避免同时运行过多任务

## 🛠️ 故障排除

### 常见问题解决

**Hook 不工作：**
- 检查脚本执行权限 `chmod +x script.sh`
- 验证脚本语法 `bash -n script.sh`
- 查看执行日志

**MCP 连接失败：**
- 检查网络连接
- 验证 MCP 服务器配置
- 查看错误日志

**Skills 无法加载：**
- 验证技能文件格式
- 检查技能部署路径
- 查看技能调用日志

### 调试方法

**启用详细日志：**
```bash
# 设置环境变量启用调试
export CLAUDE_DEBUG=true
claude
```

**查看 Hook 执行日志：**
```bash
# 查看 Hook 执行情况
tail -f ~/.claude/logs/hook-execution.log
```

---

**需要更多帮助？** 查看 [主文档](../README.md) 或 [提交 Issue](https://github.com/cfrs2005/claude-init/issues)